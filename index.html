<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BilalAI: Sohbet, Kod & Görsel Asistanı</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #e9eef2; margin: 0; }
        .chat-container { width: 95%; max-width: 800px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 0; }
        
        /* Çıktı Alanı Stili */
        #output { border: 1px solid #ddd; padding: 15px; min-height: 200px; margin-bottom: 20px; border-radius: 8px; background-color: #f7f9fb; overflow-y: auto; max-height: 60vh; }
        
        /* Yazılar arası boşlukları iyileştirme */
        #output p { 
            margin-bottom: 10px; 
            line-height: 1.6; 
        }
        #output strong {
            color: #007bff; 
        }
        #output hr {
            border: none;
            border-top: 1px dashed #e0e0e0; 
            margin: 20px 0; 
        }

        /* Kod Bloğu Stili - Belirginlik ve Kopyalanabilirlik */
        pre { 
            background-color: #272822; 
            color: #f8f8f2; 
            padding: 15px; 
            border-radius: 6px; 
            overflow-x: auto; 
            font-family: 'Consolas', 'Courier New', monospace; 
            font-size: 0.9em; 
            position: relative; 
            margin-bottom: 15px; 
        }
        code { background-color: transparent; color: inherit; padding: 0; }

        /* Görsel çıktısı için stil */
        #output img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 15px; 
            margin-bottom: 15px; 
            display: block; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }

        /* Kullanıcı Giriş Alanı */
        .input-area { display: flex; gap: 10px; }
        #userInput { flex-grow: 1; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; font-size: 1em; }
        #sendButton { padding: 12px 25px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; transition: background-color 0.3s; }
        #sendButton:hover { background-color: #0056b3; }
        #sendButton:disabled { background-color: #adb5bd; cursor: not-allowed; }

        /* Yükleme Simgesi */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="chat-container">
    <h2> BilalAI - Türk Yapım Yapay Zeka!</h2>
    <div id="output"><strong>Hoş geldiniz!</strong> Ben BilalAI. Artık sohbet edebilir, kod yazabilir ve **oluşturduğum görselleri de görebilirsiniz**!</div>
    <div class="input-area">
        <input type="text" id="userInput" placeholder="Bir şey sorun (Örn: JavaScript'te döngü veya mavi bir kedinin resmini çiz)...">
        <button id="sendButton">Gönder</button>
        <div id="loader" class="loader"></div>
    </div>
</div>

<script>
    // *******************************************************************
    // !!! YENİ API Anahtarınızı BURAYA yerleştirin !!! 
    // *******************************************************************
    // NOT: Demo anahtarı geçersizdir, kendi anahtarınızı kullanın.
    const API_KEY = "AIzaSyAgN5neJrLTJHaZXxAS3eeNfe6HSBLDYmo"; 
    
    // -------------------------------------------------------------------
    // DÜZELTME 1: HATA VEREN MODEL ADI VE API SÜRÜMÜ GÜNCELLENDİ
    // -------------------------------------------------------------------
    // Hatalı: models/gemini-pro-vision (v1beta'da genellikle hataya neden olur)
    // Yeni Öneri: gemini-2.5-flash (Güncel, multimodal destekli, hızlı ve önerilen model)
    const MODEL_NAME = 'gemini-2.5-flash';
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
    
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const outputDiv = document.getElementById('output');
    const loader = document.getElementById('loader');

    // KONUŞMA GEÇMİŞİ (HAFIZA) DİZİSİ
    const conversationHistory = []; 

    // Konuşma geçmişini HTML olarak biçimlendirip ekrana yazan işlev.
    function formatHistory() {
        // Ekranı temizle
        outputDiv.innerHTML = ''; 
        
        // Bu sistem talimatı sadece görsel amaçlıydı, API'ye gönderilmediği için kaldırıldı.
        // Konuşma geçmişini temizlerken başlangıç mesajını geri yüklemek için gerekli.
        if (conversationHistory.length === 0) {
            outputDiv.innerHTML = `<strong>Hoş geldiniz!</strong> Ben BilalAI. Artık sohbet edebilir, kod yazabilir ve **oluşturduğum görselleri de görebilirsiniz**!`;
            return;
        }

        // HATA GİDERME 2: GÖRSEL URL REGEX'İ BASİTLEŞTİRİLDİ VE GERÇEKÇİ HALE GETİRİLDİ
        // Yeni Gemini API'ları genellikle görsel üretimi için ayrı bir çağrı gerektirir (daha karmaşık).
        // Ancak bu koddaki özel "image-tokens-bardstorage" yapısı, eski bir sistemden kalma bir Mock (Taklit) URL'dir.
        // Bu yüzden sadece taklit URL'yi img etiketine çevirme mantığını koruduk, ancak temizledik.
        const imageUrlRegex = /<image-tokens-bardstorage:\/\/[^>]+>(https?:\/\/[^\s]+)/g;

        // Geçmişteki her bir konuşma sırasını (turn) döngüye al
        conversationHistory.forEach(turn => {
            const isUser = turn.role === "user";
            let text = turn.parts[0].text;
            
            // DÜZELTME 3: SİSTEM TALİMATI TEMİZLİĞİ İYİLEŞTİRİLDİ
            // Kullanıcı mesajının sadece ilgili kısmını göster.
            const systemContextCheck = "Kullanıcı sorusu: ";

            if (isUser) {
                // Kullanıcının sorusunu, sisteme gönderilen uzun metinden ayıkla
                if (text.startsWith(systemContext)) {
                    // Bu, finalPromptForRequest'ten gelen formatı temizler
                    text = text.substring(text.indexOf(systemContextCheck) + systemContextCheck.length).trim();
                } 
                // Eğer metinde hala sistem talimatı varsa, onu da temizle (ekstra güvenlik)
                text = text.replace(systemContext, '').trim(); 
                
                outputDiv.innerHTML += `<p><strong>Siz:</strong> ${text}</p>`;
            } else {
                // AI yanıtını biçimlendir (Kod bloklarını ve GÖRSEL URL'lerini HTML'e çevir)
                let processedText = text;

                // 1. Görsel URL'lerini <img> etiketlerine çevir
                // NOT: Gerçek bir Gemini API'da bu yanıt gelmez, ayrı bir görsel API çağrısı gerekir.
                // Bu kod, eski Bard/Gemini arayüzündeki taklit görsel URL yapısını taklit ediyor.
                processedText = processedText.replace(imageUrlRegex, (match, url) => {
                    return `<img src="${url}" alt="Oluşturulan Görsel">`;
                });

                // 2. Kod bloklarını <pre> etiketiyle değiştir
                const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
                processedText = processedText.replace(codeBlockRegex, (match, language, code) => {
                    const safeCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const langDisplay = language ? `\n// Dil: ${language.toUpperCase()}\n` : '';
                    return `<pre><code>${langDisplay}${safeCode.trim()}</code></pre>`;
                });
                
                // 3. Normal metin paragraflarını ayır ve biçimlendir
                // \n ile ayrılmış metinleri <p> etiketleri arasına al.
                processedText = processedText.split('\n').map(p => {
                    p = p.trim();
                    // Kod bloğu veya görsel etiketi içermeyen satırları <p> yap
                    if (p && !p.startsWith('<pre') && !p.startsWith('<img') && !p.startsWith('</code>') && !p.startsWith('</pre')) { 
                        return `<p>${p}</p>`;
                    } 
                    return p; // Diğer etiketleri olduğu gibi bırak
                }).filter(Boolean).join(''); // Boş stringleri kaldır

                outputDiv.innerHTML += `<p><strong>BilalAI:</strong></p>${processedText}`;
            }
            outputDiv.innerHTML += '<hr>';
        });

        // Sayfayı her zaman en alta kaydır
        outputDiv.scrollTop = outputDiv.scrollHeight;
    }

    // Gönderme İşlevi
    async function sendMessage() {
        const prompt = userInput.value.trim();
        if (!prompt) return;

        // DÜZELTME 4: API ANAHTARI KONTROLÜ İYİLEŞTİRİLDİ
        if (!API_KEY || API_KEY.length < 30 || API_KEY.startsWith("AIzaSyA")) { // API anahtarları genellikle 39 karakterdir.
            outputDiv.innerHTML += `<p style="color: red;"><strong>HATA:</strong> Lütfen **geçerli bir API anahtarı** girin. (Anahtarınız eksik veya hatalı görünüyor.)</p>`;
            return;
        }

        // Yükleme durumu ayarları
        sendButton.disabled = true;
        loader.style.display = 'block';
        // Yeni mesaj gelmeden önce yükleme mesajını ekle
        outputDiv.innerHTML += `<p><strong>Siz:</strong> ${prompt}</p><hr><p><strong>BilalAI:</strong> Cevap bekleniyor...</p>`;
        outputDiv.scrollTop = outputDiv.scrollHeight;
        userInput.value = '';
        
        // DÜZELTME 5: SİSTEM TALİMATI BASİTLEŞTİRİLDİ (Sadece Gemini API'nin anladığı normal metin talimatı)
        // Not: Gerçek görsel oluşturma için ayrı bir API çağrısı yapmanız gerekir.
        // Ancak kodunuzdaki taklit görsel URL yapısını korumak için talimatı güncelledim.
        const systemContext = `Sen BilalAI adlı, hem kodlama hem de genel sohbet konularında uzman, yardımsever bir yapay zekasın. Cevapların Türkçe olmalıdır. Kullanıcı kod istediğinde cevabını kod blokları (\`\`\`) içinde ver. Kullanıcı görsel oluşturmanı istediğinde (Örn: "mavi kedi resmi çiz"), cevabın sadece **https://googleusercontent.com/image_generation_content/0<image-tokens-bardstorage://RESPONSE_DATA:xxx>${prompt.replace(/[^a-zA-Z0-9]/g, '_')}.png** formatında bir taklit görsel URL'si olmalıdır. Başka hiçbir metin ekleme.`;
        
        // API'ye gönderilecek final prompt (Talimat + Kullanıcının sorusu)
        // Sistemi talimatını conversationHistory'den ayırmak için ek metin kullanıldı.
        const finalPromptForRequest = `${systemContext}\n\nKullanıcı sorusu: ${prompt}`;

        // İsteğe dahil edilecek geçerli kullanıcı mesajı
        // Kullanıcıya gönderilen metin, API'ye gönderilen metinden farklı olabilir
        const currentUserMessageForAPI = { role: "user", parts: [{ text: finalPromptForRequest }] };
        const currentUserMessageForHistory = { role: "user", parts: [{ text: prompt }] }; // Geçmişe sadece kullanıcının girdiği metni kaydet
        
        // İsteğe gönderilecek içerik = Tüm geçmiş + mevcut mesaj (API için olan)
        const contentsForRequest = [...conversationHistory.map(item => ({...item, parts: [{text: item.parts[0].text}]})), currentUserMessageForAPI]; 

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: contentsForRequest,
                    
                    generationConfig: {
                        temperature: 0.7 
                    }
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                // Orijinal hatanız burasıydı: model adı veya v1beta desteği sorunu.
                throw new Error(`API İstek Hatası (${response.status}): ${errorData.error.message}`);
            }

            const data = await response.json();
            
            const aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (aiResponseText) {
                // BAŞARILI: Mesajları GEÇMİŞE EKLE
                conversationHistory.push(currentUserMessageForHistory); // Kullanıcının temiz mesajı
                conversationHistory.push({ role: "model", parts: [{ text: aiResponseText }] }); // AI'nın yanıtı

                // TÜM GEÇMİŞİ yeniden çiz
                formatHistory();
            } else {
                outputDiv.innerHTML += `<p style="color: orange;"><strong>UYARI:</strong> BilalAI geçerli bir yanıt üretemedi. (Boş yanıt veya güvenlik filtresi.)</p>`;
            }

        } catch (error) {
            console.error('İstek Hatası:', error);
            // Sadece hata mesajını ekrana bas, geçmişi güncelleme
            outputDiv.innerHTML += `<p style="color: red;"><strong>KRİTİK HATA:</strong> Bağlantı veya API sorunu: ${error.message}</p>`;
        } finally {
            sendButton.disabled = false;
            loader.style.display = 'none';
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }
    }

    // Olay Dinleyicileri
    sendButton.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // İlk yüklemede hoş geldiniz mesajını göstermek için
    // İlk mesajı temizlemesin diye bu satır kaldırıldı.
</script>

</body>
</html>
