<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BilalAI: Sohbet, Kod & Görsel Asistanı</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #e9eef2; margin: 0; }
        .chat-container { width: 95%; max-width: 800px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 0; }
        
        /* Çıktı Alanı Stili */
        #output { border: 1px solid #ddd; padding: 15px; min-height: 200px; margin-bottom: 20px; border-radius: 8px; background-color: #f7f9fb; overflow-y: auto; max-height: 60vh; }
        
        /* Yazılar arası boşlukları iyileştirme */
        #output p { 
            margin-bottom: 10px; /* Paragraflar arasına boşluk */
            line-height: 1.6; /* Satır yüksekliği artırma */
        }
        #output strong {
            color: #007bff; /* Konuşmacı adlarını belirginleştir */
        }
        #output hr {
            border: none;
            border-top: 1px dashed #e0e0e0; /* Kesikli çizgi ile ayrım */
            margin: 20px 0; /* Çizgi üst ve altına boşluk */
        }

        /* Kod Bloğu Stili - Belirginlik ve Kopyalanabilirlik */
        pre { 
            background-color: #272822; 
            color: #f8f8f2; 
            padding: 15px; 
            border-radius: 6px; 
            overflow-x: auto; 
            font-family: 'Consolas', 'Courier New', monospace; 
            font-size: 0.9em; 
            position: relative; 
            margin-bottom: 15px; /* Kod bloğu altına boşluk */
        }
        code { background-color: transparent; color: inherit; padding: 0; }

        /* Görsel çıktısı için stil */
        #output img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 15px; /* Görsel üstüne boşluk */
            margin-bottom: 15px; /* Görsel altına boşluk */
            display: block; /* Metinle çakışmaması için */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* Görselde hafif gölge */
        }

        /* Kullanıcı Giriş Alanı */
        .input-area { display: flex; gap: 10px; }
        #userInput { flex-grow: 1; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; font-size: 1em; }
        #sendButton { padding: 12px 25px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; transition: background-color 0.3s; }
        #sendButton:hover { background-color: #0056b3; }
        #sendButton:disabled { background-color: #adb5bd; cursor: not-allowed; }

        /* Yükleme Simgesi */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="chat-container">
    <h2> BilalAI - Türk Yapımı Yapay Zeka!</h2>
    <div id="output"><strong>Hoş geldiniz!</strong> Ben BilalAI. Artık sohbet edebilir, kod yazabilir ve **oluşturduğum görselleri de görebilirsiniz**!</div>
    <div class="input-area">
        <input type="text" id="userInput" placeholder="Bir şey sorun (Örn: JavaScript'te döngü veya mavi bir kedinin resmini çiz)...">
        <button id="sendButton">Gönder</button>
        <div id="loader" class="loader"></div>
    </div>
</div>

<script>
    // *******************************************************************
    // !!! YENİ API Anahtarınızı BURAYA yerleştirin !!! 
    // *******************************************************************
    const API_KEY = "AIzaSyAgN5neJrLTJHaZXxAS3eeNfe6HSBLDYmo"; 
    
    // API endpoint ve model adı
    // Genellikle 'gemini-pro-vision' gibi modeller görsel yeteneklere daha uygundur,
    // ancak mevcut 'gemini-2.5-flash' da bazen basit görsel yanıtlar verebilir.
    // En iyi görsel sonuçlar için modelinizi kontrol edin veya gerekirse değiştirin.
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
    
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const outputDiv = document.getElementById('output');
    const loader = document.getElementById('loader');

    // KONUŞMA GEÇMİŞİ (HAFIZA) DİZİSİ
    const conversationHistory = []; 

    // Konuşma geçmişini HTML olarak biçimlendirip ekrana yazan işlev.
    function formatHistory() {
        // Ekranı temizle
        outputDiv.innerHTML = ''; 
        
        // Sistem Talimatı (Sadece görüntüden çıkarmak için gerekli)
        const systemContext = "Sen BilalAI adlı, hem kodlama hem de genel sohbet konularında uzman, yardımsever bir yapay zekasın. Cevapların Türkçe, bilgilendirici ve dostça olmalıdır. Kullanıcı kod istediğinde cevabını kod blokları (```) içinde vermeye özen göster. Ayrıca, kullanıcı görsel oluşturmanı istediğinde, bu isteği doğrudan yapay zeka modeline (yani sana yanıt veren ana modelime) ilet ve bir görselin oluşturulması için yönlendir. Görsel oluşturduktan sonra sadece görselin URL'sini `<image-tokens-bardstorage://RESPONSE_DATA:...>` şeklinde döndür. Başka hiçbir metin ekleme.";

        // Görsel URL kalıbı (http://googleusercontent.com/image_generation_content/...)
        // Bu regex daha esnek hale getirildi
        const imageUrlRegex = /https?:\/\/googleusercontent\.com\/image_generation_content\/0<image-tokens-bardstorage:[^>]+>/g;

        // Geçmişteki her bir konuşma sırasını (turn) döngüye al
        conversationHistory.forEach(turn => {
            const isUser = turn.role === "user";
            let text = turn.parts[0].text;
            
            // Eğer rol kullanıcı ise, AI'a gönderilen bağlamı (systemContext) metinden temizle
            if (isUser) {
                // Kullanıcının gerçek sorusunu bul ve temizle
                const userQuestionMatch = text.match(/Kullanıcı sorusu: ([\s\S]*)/);
                if (userQuestionMatch) {
                    text = userQuestionMatch[1].trim();
                } else {
                    // Güvenlik amaçlı, sadece bağlamı kaldır
                    text = text.replace(systemContext, '').replace('Kullanıcı sorusu:', '').trim();
                }
                outputDiv.innerHTML += `<p><strong>Siz:</strong> ${text}</p>`;
            } else {
                // AI yanıtını biçimlendir (Kod bloklarını ve GÖRSEL URL'lerini HTML'e çevir)
                let processedText = text;

                // 1. Görsel URL'lerini <img> etiketlerine çevir
                processedText = processedText.replace(imageUrlRegex, (match) => {
                    // match içindeki token'ları ve fazlalıkları temizleyerek sadece URL kısmını al
                    // image-tokens-bardstorage kısmı tamamen kaldırıldı, sadece URL kaldı
                    const cleanedUrl = match.replace(/<image-tokens-bardstorage:[^>]+>/, '');
                    return `<img src="${cleanedUrl}" alt="Oluşturulan Görsel">`;
                });

                // 2. Kod bloklarını <pre> etiketiyle değiştir
                const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
                processedText = processedText.replace(codeBlockRegex, (match, language, code) => {
                    const safeCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const langDisplay = language ? `\n\n// Dil: ${language.toUpperCase()}\n\n` : '';
                    return `<pre><code>${langDisplay}${safeCode.trim()}</code></pre>`;
                });
                
                // 3. Normal metin paragraflarını ayır ve biçimlendir
                // Görsel veya kod bloğu içermeyen her satırı bir paragrafa dönüştür
                processedText = processedText.split('\n').map(p => {
                    p = p.trim();
                    if (p && !p.startsWith('<pre') && !p.startsWith('<img')) { 
                        return `<p>${p}</p>`;
                    } else if (p.startsWith('<pre') || p.startsWith('<img')) {
                        return p; // pre veya img etiketini olduğu gibi bırak
                    }
                    return ''; // Boş satırları atla
                }).filter(Boolean).join(''); // Boş stringleri kaldır

                outputDiv.innerHTML += `<p><strong>BilalAI:</strong></p>${processedText}`;
            }
            outputDiv.innerHTML += '<hr>';
        });

        // Sayfayı her zaman en alta kaydır
        outputDiv.scrollTop = outputDiv.scrollHeight;
    }

    // Gönderme İşlevi
    async function sendMessage() {
        const prompt = userInput.value.trim();
        if (!prompt) return;

        // API anahtarı boşsa uyarı ver ve çık
        if (API_KEY === "YENİ_API_ANAHTARINIZI_BURAYA_EKLEYİN" || !API_KEY || API_KEY.length < 20) { // Basit anahtar kontrolü
            outputDiv.innerHTML += `<p style="color: red;"><strong>HATA:</strong> Lütfen geçerli bir API anahtarı girin. Anahtarınız eksik veya hatalı.</p>`;
            return;
        }


        // Yükleme durumu ayarları
        sendButton.disabled = true;
        loader.style.display = 'block';
        outputDiv.innerHTML += `<p><strong>Siz:</strong> ${prompt}</p><hr><p>AI: Cevap bekleniyor...</p>`;
        userInput.value = '';
        
        // BilalAI'nın talimatı (API'nin kabul ettiği tek geçerli yöntem: Prompt'a ekleme)
        // Görsel oluşturma yeteneği ve özel çıktı formatı eklendi
        const systemContext = "Sen BilalAI adlı, hem kodlama hem de genel sohbet konularında uzman, yardımsever bir yapay zekasın. Cevapların Türkçe, bilgilendirici ve dostça olmalıdır. Kullanıcı kod istediğinde cevabını kod blokları (```) içinde vermeye özen göster. Ayrıca, kullanıcı görsel oluşturmanı istediğinde, bu isteği doğrudan yapay zeka modeline (yani sana yanıt veren ana modelime) ilet ve bir görselin oluşturulması için yönlendir. Görsel oluşturduktan sonra başka hiçbir metin eklemeden, sadece oluşturulan görselin URL'sini `<image-tokens-bardstorage://RESPONSE_DATA:...>` şeklinde döndür. Bu URL formatını doğrudan kullan. Eğer yanıt görsel değilse, normal metin olarak yanıt ver.";
        
        // API'ye gönderilecek final prompt (Talimat + Kullanıcının sorusu)
        const finalPromptForRequest = `${systemContext}\n\nKullanıcı sorusu: ${prompt}`;

        // İsteğe dahil edilecek geçerli kullanıcı mesajı
        const currentUserMessage = { role: "user", parts: [{ text: finalPromptForRequest }] };
        
        // İsteğe gönderilecek içerik = Tüm geçmiş + mevcut mesaj
        const contentsForRequest = [...conversationHistory, currentUserMessage]; 

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: contentsForRequest,
                    
                    generationConfig: {
                        temperature: 0.7 
                    }
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API İstek Hatası (${response.status}): ${errorData.error.message}`);
            }

            const data = await response.json();
            
            const aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (aiResponseText) {
                // BAŞARILI: Mesajları GEÇMİŞE EKLE
                conversationHistory.push(currentUserMessage);
                conversationHistory.push({ role: "model", parts: [{ text: aiResponseText }] });

                // TÜM GEÇMİŞİ yeniden çiz
                formatHistory();
            } else {
                outputDiv.innerHTML += `<p style="color: orange;"><strong>UYARI:</strong> BilalAI geçerli bir yanıt üretemedi. (Boş yanıt veya güvenlik filtresi.)</p>`;
            }

        } catch (error) {
            console.error('İstek Hatası:', error);
            // Sadece hata mesajını ekrana bas, geçmişi güncelleme
            outputDiv.innerHTML += `<p style="color: red;"><strong>KRİTİK HATA:</strong> Bağlantı veya API sorunu: ${error.message}</p>`;
        } finally {
            sendButton.disabled = false;
            loader.style.display = 'none';
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }
    }

    // Olay Dinleyicileri
    sendButton.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // İlk yüklemede hoş geldiniz mesajını göstermek için (isteğe bağlı)
    // formatHistory(); 
</script>

</body>
</html>
