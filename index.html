<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BilalAI: Tam SÃ¼rÃ¼m Sohbet, Kod & GÃ¶rsel AsistanÄ±</title>
    <style>
        /* Genel Stiller */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #e9eef2;
            margin: 0;
        }
        .chat-container {
            width: 95%;
            max-width: 800px;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); /* Daha belirgin gÃ¶lge */
            display: flex;
            flex-direction: column;
            min-height: 85vh; /* YÃ¼ksekliÄŸi sabitlemek iÃ§in */
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }
        
        /* Ã‡Ä±ktÄ± AlanÄ± Stili */
        #output {
            flex-grow: 1; /* Geriye kalan tÃ¼m alanÄ± kapla */
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: #f7f9fb;
            overflow-y: auto;
            max-height: 70vh; /* Maksimum yÃ¼kseklik sÄ±nÄ±rÄ± */
            border: 1px solid #ddd;
        }

        /* Mesaj BalonlarÄ± Stilleri (YENÄ°) */
        .message-turn {
            margin-bottom: 20px;
            padding: 10px 15px;
            border-radius: 12px;
            clear: both;
            max-width: 85%;
            word-wrap: break-word; /* Uzun kelimeleri kÄ±rma */
        }
        .user-message {
            background-color: #007bff;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 2px;
            float: right;
        }
        .ai-message {
            background-color: #ffffff;
            border: 1px solid #e9eef2;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 2px;
            float: left;
        }
        .message-turn strong:first-child {
            display: block;
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
            font-weight: 700;
        }
        #output p {
            margin: 0 0 10px 0;
            line-height: 1.6;
            font-weight: normal;
        }
        #output h3, #output h4 {
            margin-top: 15px;
            margin-bottom: 10px;
            color: #0056b3;
            border-bottom: 1px dashed #e0e0e0;
            padding-bottom: 5px;
        }
        #output hr { display: none; } /* Yatay Ã§izgileri kaldÄ±r */

        /* Kod BloÄŸu Stili */
        pre {
            background-color: #272822;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.9em;
            margin-top: 10px;
            margin-bottom: 10px;
            white-space: pre-wrap; /* Uzun satÄ±rlarÄ± otomatik kÄ±rma */
            word-wrap: break-word;
        }
        :not(pre) > code {
            background-color: #e0e7ff;
            color: #1a4d94;
            padding: 2px 5px;
            border-radius: 3px;
        }

        /* Liste Stili (YENÄ°) */
        #output ul {
            list-style: disc inside;
            padding-left: 20px;
            margin: 10px 0;
        }
        #output li {
            margin-bottom: 5px;
            line-height: 1.5;
        }

        /* GÃ¶rsel Ã§Ä±ktÄ±sÄ± iÃ§in stil */
        #output img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 15px;
            margin-bottom: 15px;
            display: block;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* KullanÄ±cÄ± GiriÅŸ AlanÄ± */
        .input-area { 
            display: flex; 
            gap: 10px; 
            align-items: flex-end; /* Ã–ÄŸeleri aÅŸaÄŸÄ± hizalar */
        }
        #userInput { /* Input yerine TEXTAREA kullanÄ±ldÄ± */
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            min-height: 50px; /* Textarea iÃ§in minimum yÃ¼kseklik */
            resize: vertical; /* Sadece dikey yeniden boyutlandÄ±rma */
            min-width: 0;
        }
        #sendButton {
            padding: 12px 25px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
            flex-shrink: 0;
            height: 50px; /* Buton yÃ¼ksekliÄŸini eÅŸitlemek iÃ§in */
        }
        #sendButton:hover { background-color: #0056b3; }
        #sendButton:disabled { background-color: #adb5bd; cursor: not-allowed; }

        /* YÃ¼kleme Simgesi */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
            margin: auto 0 auto 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="chat-container">
    <h2> BilalAI - TÃ¼rk YapÄ±m Yapay Zeka! ğŸ‡¹ğŸ‡·</h2>
    <div id="output"></div> 
    <div class="input-area">
        <textarea id="userInput" rows="3" placeholder="Bir ÅŸey sorun (Ã–rn: JavaScript'te dÃ¶ngÃ¼ veya mavi bir kedinin resmini Ã§iz)..."></textarea>
        <button id="sendButton">GÃ¶nder</button>
        <div id="loader" class="loader"></div>
    </div>
</div>

<script>
    // *******************************************************************
    // !!! YENÄ° API AnahtarÄ±nÄ±zÄ± BURAYA yerleÅŸtirin !!! 
    // *******************************************************************
    // LÃœTFEN BU YER TUTUCU ANAHTARI KENDÄ° GERÃ‡EK ANAHTARINIZLA DEÄÄ°ÅTÄ°RÄ°N
    const API_KEY = "AIzaSyChiJsYckDX74Drl0cZTFr3-8T7bfLH0Us"; 
    
    // -------------------------------------------------------------------
    // Model ve API URL'si
    // -------------------------------------------------------------------
    const MODEL_NAME = 'gemini-2.5-flash';
    const API_URL = `https://generativelanguage.googleapis.com/v1/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
    
    // **Sistem TalimatÄ±:** GÃ¶rsel oluÅŸturma komutu ve rol tanÄ±mÄ±.
    const systemContext = `Sen BilalAI adlÄ±, hem kodlama hem de genel sohbet konularÄ±nda uzman, yardÄ±msever bir yapay zekasÄ±n. CevaplarÄ±n TÃ¼rkÃ§e olmalÄ±dÄ±r. KullanÄ±cÄ± kod istediÄŸinde cevabÄ±nÄ± kod bloklarÄ± (\`\`\`) iÃ§inde ver. KullanÄ±cÄ± gÃ¶rsel oluÅŸturmanÄ± istediÄŸinde (Ã–rn: "mavi kedi resmi Ã§iz"), cevabÄ±n sadece **https://googleusercontent.com/image_generation_content/0<image-tokens-bardstorage://RESPONSE_DATA:xxx>${'PROMPT_PLACEHOLDER'.replace(/[^a-zA-Z0-9]/g, '_')}.png** formatÄ±nda bir taklit gÃ¶rsel URL'si olmalÄ±dÄ±r. BaÅŸka hiÃ§bir metin ekleme.`;
    const systemContextCheck = "KullanÄ±cÄ± sorusu:"; // KullanÄ±cÄ± sorusunu ayÄ±klamak iÃ§in sabit metin

    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const outputDiv = document.getElementById('output');
    const loader = document.getElementById('loader');

    // KONUÅMA GEÃ‡MÄ°ÅÄ° (HAFIZA) DÄ°ZÄ°SÄ° - Sadece temiz mesajlarÄ± tutar
    const conversationHistory = []; 

    // Ä°lk HoÅŸ Geldiniz MesajÄ±
    function displayInitialMessage() {
        outputDiv.innerHTML = `<div class="message-turn ai-message">
                                <strong>BilalAI</strong>
                                <p><strong>HoÅŸ geldiniz!</strong> Ben BilalAI. ArtÄ±k sohbet edebilir, kod yazabilir ve **oluÅŸturduÄŸum gÃ¶rselleri de gÃ¶rebilirsiniz**!</p>
                            </div>`;
    }

    // KonuÅŸma geÃ§miÅŸini HTML olarak biÃ§imlendirip ekrana yazan iÅŸlev.
    function formatHistory() {
        outputDiv.innerHTML = '';
        
        if (conversationHistory.length === 0) {
            displayInitialMessage();
            return;
        }

        const imageUrlRegex = /https?:\/\/googleusercontent\.com\/image_generation_content\/0<image-tokens-bardstorage:\/\/[^>]+>([^\s]+)\.png/g;
        // Not: Regex, URL'nin tamamÄ±nÄ± yakalamasÄ± iÃ§in dÃ¼zenlendi.

        conversationHistory.forEach(turn => {
            const isUser = turn.role === "user";
            let text = turn.parts[0].text;
            let finalHtml = '';
            
            if (isUser) {
                // KullanÄ±cÄ± mesajÄ± (Zaten temiz)
                finalHtml = text.replace(/\n/g, '<br>');
                
                outputDiv.innerHTML += `<div class="message-turn user-message">
                                            <strong>Siz</strong>
                                            ${finalHtml}
                                        </div>`;
            } else {
                // AI yanÄ±tÄ±nÄ± biÃ§imlendir (Markdown to HTML dÃ¶nÃ¼ÅŸÃ¼mÃ¼)
                let processedText = text;

                // 1. GÃ¶rsel URL'lerini <img> etiketlerine Ã§evir
                processedText = processedText.replace(imageUrlRegex, (match, url) => {
                    // url zaten PROMPT_PLACEHOLDER.png ile bitiyor
                    return `<img src="${match.match(/(https?:\/\/[^\s]+)/)[0]}" alt="OluÅŸturulan GÃ¶rsel">`;
                });

                // 2. Kod bloklarÄ±nÄ± <pre> etiketiyle deÄŸiÅŸtir (Ä°lk iÅŸlenmeli)
                const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
                processedText = processedText.replace(codeBlockRegex, (match, language, code) => {
                    const safeCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const langDisplay = language ? `// Dil: ${language.toUpperCase()}\n\n` : '';
                    return `<pre><code>${langDisplay}${safeCode.trim()}</code></pre>`;
                });
                
                // 3. Markdown formatÄ±nÄ± HTML'e Ã§evir (BaÅŸlÄ±klar, Bold, Ä°talik)
                processedText = processedText
                    .replace(/### (.*)/g, '<h4>$1</h4>') 
                    .replace(/## (.*)/g, '<h3>$1</h3>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/^- (.*)$/gm, '<li>$1</li>'); // Madde iÅŸaretli listeler

                // 4. Listeleri <ul> etiketlerine sar (Basit sarma)
                let listWrappedText = '';
                const parts = processedText.split('\n');
                let inList = false;

                for (const line of parts) {
                    if (line.startsWith('<li>')) {
                        if (!inList) {
                            listWrappedText += '<ul>';
                            inList = true;
                        }
                        listWrappedText += line;
                    } else {
                        if (inList) {
                            listWrappedText += '</ul>';
                            inList = false;
                        }
                        // BoÅŸluklarÄ± yÃ¶netmek iÃ§in <br> yerine <p> kullanÄ±mÄ±
                        if (line.trim()) {
                             listWrappedText += `<p>${line.replace(/\n/g, '<br>')}</p>`;
                        }
                    }
                }
                if (inList) { listWrappedText += '</ul>'; }
                processedText = listWrappedText;

                // 5. <pre> ve <img> dÄ±ÅŸÄ±ndaki metin bloklarÄ±nÄ± yÃ¶net
                const htmlParts = processedText.split(/(<pre>[\s\S]*?<\/pre>|<img[\s\S]*?>|<h3>[\s\S]*?<\/h3>|<h4>[\s\S]*?<\/h4>|<ul>[\s\S]*?<\/ul>)/);
                
                htmlParts.forEach(part => {
                    if (part) {
                        if (part.startsWith('<pre') || part.startsWith('<img') || part.startsWith('<h') || part.startsWith('<ul')) {
                            finalHtml += part;
                        } else {
                            // Paragraf veya liste dÄ±ÅŸÄ± metinleri <p> etiketleri arasÄ±na al
                            part.split('\n\n').forEach(p => {
                                if (p.trim()) {
                                    finalHtml += `<p>${p.trim().replace(/\n/g, '<br>')}</p>`;
                                }
                            });
                        }
                    }
                });

                outputDiv.innerHTML += `<div class="message-turn ai-message">
                                            <strong>BilalAI</strong>
                                            ${finalHtml}
                                        </div>`;
            }
        });

        // SayfayÄ± her zaman en alta kaydÄ±r
        outputDiv.scrollTop = outputDiv.scrollHeight;
    }

    // GÃ¶nderme Ä°ÅŸlevi
    async function sendMessage() {
        const prompt = userInput.value.trim();
        if (!prompt) return;

        // API AnahtarÄ± KontrolÃ¼
        if (!API_KEY || API_KEY.length < 30 || API_KEY.startsWith("AIzaSyA") || API_KEY.endsWith("mo")) { 
            outputDiv.innerHTML += `<div class="message-turn ai-message" style="border-color: red;">
                                        <strong>HATA:</strong>
                                        <p style="color: red;">LÃ¼tfen **geÃ§erli bir API anahtarÄ±** girin. (AnahtarÄ±nÄ±z eksik veya hatalÄ± gÃ¶rÃ¼nÃ¼yor.)</p>
                                    </div>`;
            outputDiv.scrollTop = outputDiv.scrollHeight;
            return;
        }

        // YÃ¼kleme durumu ayarlarÄ±
        sendButton.disabled = true;
        loader.style.display = 'block';
        
        const cleanUserMessage = prompt; 
        
        // KullanÄ±cÄ±ya gÃ¶nderilen metin (geÃ§miÅŸe eklenecek temiz metin)
        const currentUserMessageForHistory = { role: "user", parts: [{ text: cleanUserMessage }] }; 
        
        // GeÃ§ici yÃ¼kleme mesajÄ± (EkranÄ± anÄ±nda gÃ¼ncelle)
        const loadingHtml = `<div class="message-turn user-message">
                                <strong>Siz</strong>
                                ${cleanUserMessage}
                             </div>
                             <div class="message-turn ai-message" id="temp-loader-msg" style="opacity: 0.7;">
                                <strong>BilalAI</strong>
                                <p>Cevap bekleniyor...</p>
                            </div>`;

        outputDiv.innerHTML += loadingHtml;
        outputDiv.scrollTop = outputDiv.scrollHeight;
        userInput.value = '';

        // SÄ°STEM TALÄ°MATI DÄ°NAMÄ°K OLARAK GÃœNCELLENDÄ° (GÃ¶rsel prompt'u iÃ§in)
        const dynamicSystemContext = systemContext.replace('PROMPT_PLACEHOLDER', prompt.replace(/[^a-zA-Z0-9]/g, '_'));

        // API'ye gÃ¶nderilecek final prompt (Talimat + KullanÄ±cÄ±nÄ±n sorusu)
        const finalPromptForRequest = `${dynamicSystemContext}\n\n${systemContextCheck}${prompt}`;
        
        // API'ye gÃ¶nderilecek iÃ§erik (GeÃ§miÅŸ + Son Mesaj)
        const contentsForRequest = [
            ...conversationHistory, // GeÃ§miÅŸteki temiz mesajlar
            { role: "user", parts: [{ text: finalPromptForRequest }] } // Mevcut mesajÄ± talimatla gÃ¶nder
        ];

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: contentsForRequest,
                    config: { temperature: 0.7 }
                })
            });

            // YÃ¼kleme mesajÄ±nÄ± kaldÄ±r
            const tempMsg = document.getElementById('temp-loader-msg');
            if (tempMsg) tempMsg.remove();

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Ä°stek HatasÄ± (${response.status}): ${errorData.error.message}`);
            }

            const data = await response.json();
            
            const aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (aiResponseText) {
                // BAÅARILI: MesajlarÄ± GEÃ‡MÄ°ÅE EKLE (Temiz olarak)
                conversationHistory.push(currentUserMessageForHistory); // KullanÄ±cÄ±nÄ±n temiz mesajÄ±
                conversationHistory.push({ role: "model", parts: [{ text: aiResponseText }] }); // AI'nÄ±n yanÄ±tÄ±

                // TÃœM GEÃ‡MÄ°ÅÄ° yeniden Ã§iz
                formatHistory();
            } else {
                outputDiv.innerHTML += `<div class="message-turn ai-message" style="border-color: orange;">
                                            <strong>UYARI:</strong>
                                            <p style="color: orange;">BilalAI geÃ§erli bir yanÄ±t Ã¼retemedi. (BoÅŸ yanÄ±t, gÃ¼venlik filtresi veya 'blockReasons' kontrol edin.)</p>
                                        </div>`;
            }

        } catch (error) {
            console.error('Ä°stek HatasÄ±:', error);
            // Hata mesajÄ±nÄ± ekrana bas
            const tempMsg = document.getElementById('temp-loader-msg');
            if (tempMsg) tempMsg.remove();
            
            outputDiv.innerHTML += `<div class="message-turn ai-message" style="border-color: red;">
                                        <strong>KRÄ°TÄ°K HATA:</strong>
                                        <p style="color: red;">BaÄŸlantÄ± veya API sorunu: ${error.message}</p>
                                    </div>`;
        } finally {
            sendButton.disabled = false;
            loader.style.display = 'none';
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }
    }

    // Olay Dinleyicileri
    sendButton.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) { // Shift+Enter satÄ±r atlamak iÃ§in kalsÄ±n
            e.preventDefault(); // VarsayÄ±lan satÄ±r atlamayÄ± engelle
            sendMessage();
        }
    });

    // Sayfa yÃ¼klendiÄŸinde ilk mesajÄ± gÃ¶ster
    window.onload = displayInitialMessage;
</script>

</body>
</html>
