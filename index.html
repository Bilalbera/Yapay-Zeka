<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BilalAI: Sohbet, Kod & GÃ¶rsel AsistanÄ±</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #e9eef2; margin: 0; }
        .chat-container { width: 95%; max-width: 800px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 0; }
        
        /* Ã‡Ä±ktÄ± AlanÄ± Stili */
        #output { border: 1px solid #ddd; padding: 15px; min-height: 200px; margin-bottom: 20px; border-radius: 8px; background-color: #f7f9fb; overflow-y: auto; max-height: 60vh; }
        
        /* Kod BloÄŸu Stili - Belirginlik ve Kopyalanabilirlik */
        pre { 
            background-color: #272822; 
            color: #f8f8f2; 
            padding: 15px; 
            border-radius: 6px; 
            overflow-x: auto; 
            font-family: 'Consolas', 'Courier New', monospace; 
            font-size: 0.9em; 
            position: relative; 
        }
        code { background-color: transparent; color: inherit; padding: 0; }

        /* GÃ¶rsel Ã§Ä±ktÄ±sÄ± iÃ§in stil */
        #output img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
            display: block; /* Metinle Ã§akÄ±ÅŸmamasÄ± iÃ§in */
        }

        /* KullanÄ±cÄ± GiriÅŸ AlanÄ± */
        .input-area { display: flex; gap: 10px; }
        #userInput { flex-grow: 1; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; font-size: 1em; }
        #sendButton { padding: 12px 25px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; transition: background-color 0.3s; }
        #sendButton:hover { background-color: #0056b3; }
        #sendButton:disabled { background-color: #adb5bd; cursor: not-allowed; }

        /* YÃ¼kleme Simgesi */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="chat-container">
    <h2>ğŸ¨ BilalAI - Sohbet, Kod & GÃ¶rsel AsistanÄ±</h2>
    <div id="output"><strong>HoÅŸ geldiniz!</strong> Ben BilalAI. ArtÄ±k sohbet edebilir, kod yazabilir ve **oluÅŸturduÄŸum gÃ¶rselleri de gÃ¶rebilirsiniz**!</div>
    <div class="input-area">
        <input type="text" id="userInput" placeholder="Bir ÅŸey sorun (Ã–rn: JavaScript'te dÃ¶ngÃ¼ veya mavi bir kedinin resmini Ã§iz)...">
        <button id="sendButton">GÃ¶nder</button>
        <div id="loader" class="loader"></div>
    </div>
</div>

<script>
    // *******************************************************************
    // !!! YENÄ° API AnahtarÄ±nÄ±zÄ± BURAYA yerleÅŸtirin !!! 
    // *******************************************************************
    const API_KEY = "AIzaSyAgN5neJrLTJHaZXxAS3eeNfe6HSBLDYmo"; 
    
    // API endpoint ve model adÄ±
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
    
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const outputDiv = document.getElementById('output');
    const loader = document.getElementById('loader');

    // KONUÅMA GEÃ‡MÄ°ÅÄ° (HAFIZA) DÄ°ZÄ°SÄ°
    const conversationHistory = []; 

    // KonuÅŸma geÃ§miÅŸini HTML olarak biÃ§imlendirip ekrana yazan iÅŸlev.
    function formatHistory() {
        // EkranÄ± temizle
        outputDiv.innerHTML = ''; 
        
        // Sistem TalimatÄ± (Sadece gÃ¶rÃ¼ntÃ¼den Ã§Ä±karmak iÃ§in gerekli)
        const systemContext = "Sen BilalAI adlÄ±, hem kodlama hem de genel sohbet konularÄ±nda uzman, yardÄ±msever bir yapay zekasÄ±n. CevaplarÄ±n TÃ¼rkÃ§e, bilgilendirici ve dostÃ§a olmalÄ±dÄ±r. KullanÄ±cÄ± kod istediÄŸinde cevabÄ±nÄ± kod bloklarÄ± (```) iÃ§inde vermeye Ã¶zen gÃ¶ster. AyrÄ±ca, kullanÄ±cÄ± gÃ¶rsel oluÅŸturmanÄ± istediÄŸinde, bu isteÄŸi doÄŸrudan yapay zeka modeline (yani sana yanÄ±t veren ana modelime) ilet ve bir gÃ¶rselin oluÅŸturulmasÄ± iÃ§in yÃ¶nlendir. GÃ¶rsel oluÅŸturduktan sonra sadece gÃ¶rselin URL'sini <img src='GÃ–RSEL_URL'> ÅŸeklinde dÃ¶ndÃ¼r. BaÅŸka hiÃ§bir metin ekleme.";

        // GÃ¶rsel URL kalÄ±bÄ± (http://googleusercontent.com/image_generation_content/...)
        const imageUrlRegex = /http:\/\/googleusercontent\.com\/image_generation_content\/0<image-tokens-bardstorage:\/\/[^>]+>/g;

        // GeÃ§miÅŸteki her bir konuÅŸma sÄ±rasÄ±nÄ± (turn) dÃ¶ngÃ¼ye al
        conversationHistory.forEach(turn => {
            const isUser = turn.role === "user";
            let text = turn.parts[0].text;
            
            // EÄŸer rol kullanÄ±cÄ± ise, AI'a gÃ¶nderilen baÄŸlamÄ± (systemContext) metinden temizle
            if (isUser) {
                // KullanÄ±cÄ±nÄ±n gerÃ§ek sorusunu bul ve temizle
                const userQuestionMatch = text.match(/KullanÄ±cÄ± sorusu: ([\s\S]*)/);
                if (userQuestionMatch) {
                    text = userQuestionMatch[1].trim();
                } else {
                    // GÃ¼venlik amaÃ§lÄ±, sadece baÄŸlamÄ± kaldÄ±r
                    text = text.replace(systemContext, '').replace('KullanÄ±cÄ± sorusu:', '').trim();
                }
                outputDiv.innerHTML += `<p><strong>Siz:</strong> ${text}</p>`;
            } else {
                // AI yanÄ±tÄ±nÄ± biÃ§imlendir (Kod bloklarÄ±nÄ± ve GÃ–RSEL URL'lerini HTML'e Ã§evir)
                let processedText = text;

                // 1. GÃ¶rsel URL'lerini <img> etiketlerine Ã§evir
                processedText = processedText.replace(imageUrlRegex, (match) => {
                    // match iÃ§indeki token'larÄ± ve fazlalÄ±klarÄ± temizleyerek sadece URL kÄ±smÄ±nÄ± al
                    const cleanedUrl = match.replace(/<image-tokens-bardstorage:\/\/[^>]+>/, '');
                    return `<img src="${cleanedUrl}" alt="OluÅŸturulan GÃ¶rsel">`;
                });

                // 2. Kod bloklarÄ±nÄ± <pre> etiketiyle deÄŸiÅŸtir
                const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
                processedText = processedText.replace(codeBlockRegex, (match, language, code) => {
                    const safeCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const langDisplay = language ? `\n\n// Dil: ${language.toUpperCase()}\n\n` : '';
                    return `<pre><code>${langDisplay}${safeCode.trim()}</code></pre>`;
                });
                
                // 3. Normal metin paragraflarÄ±nÄ± ayÄ±r ve biÃ§imlendir
                processedText = processedText.split('\n\n').map(p => {
                    if (p.trim() && !p.startsWith('<pre>') && !p.startsWith('<img')) { // img etiketlerini de atla
                        return `<p>${p.trim()}</p>`;
                    }
                    return p;
                }).join('');
                
                outputDiv.innerHTML += `<p><strong>BilalAI:</strong></p>${processedText}`;
            }
            outputDiv.innerHTML += '<hr>';
        });

        // SayfayÄ± her zaman en alta kaydÄ±r
        outputDiv.scrollTop = outputDiv.scrollHeight;
    }

    // GÃ¶nderme Ä°ÅŸlevi
    async function sendMessage() {
        const prompt = userInput.value.trim();
        if (!prompt) return;

        // API anahtarÄ± boÅŸsa uyarÄ± ver ve Ã§Ä±k
        if (API_KEY === "YENÄ°_API_ANAHTARINIZI_BURAYA_EKLEYÄ°N" || !API_KEY || API_KEY.length < 20) { // Basit anahtar kontrolÃ¼
            outputDiv.innerHTML += `<p style="color: red;"><strong>HATA:</strong> LÃ¼tfen geÃ§erli bir API anahtarÄ± girin. AnahtarÄ±nÄ±z eksik veya hatalÄ±.</p>`;
            return;
        }


        // YÃ¼kleme durumu ayarlarÄ±
        sendButton.disabled = true;
        loader.style.display = 'block';
        outputDiv.innerHTML += `<p><strong>Siz:</strong> ${prompt}</p><hr><p>AI: Cevap bekleniyor...</p>`;
        userInput.value = '';
        
        // BilalAI'nÄ±n talimatÄ± (API'nin kabul ettiÄŸi tek geÃ§erli yÃ¶ntem: Prompt'a ekleme)
        // GÃ¶rsel oluÅŸturma yeteneÄŸi ve Ã¶zel Ã§Ä±ktÄ± formatÄ± eklendi
        const systemContext = "Sen BilalAI adlÄ±, hem kodlama hem de genel sohbet konularÄ±nda uzman, yardÄ±msever bir yapay zekasÄ±n. CevaplarÄ±n TÃ¼rkÃ§e, bilgilendirici ve dostÃ§a olmalÄ±dÄ±r. KullanÄ±cÄ± kod istediÄŸinde cevabÄ±nÄ± kod bloklarÄ± (```) iÃ§inde vermeye Ã¶zen gÃ¶ster. AyrÄ±ca, kullanÄ±cÄ± gÃ¶rsel oluÅŸturmanÄ± istediÄŸinde, bu isteÄŸi doÄŸrudan yapay zeka modeline (yani sana yanÄ±t veren ana modelime) ilet ve bir gÃ¶rselin oluÅŸturulmasÄ± iÃ§in yÃ¶nlendir. GÃ¶rsel oluÅŸturduktan sonra baÅŸka hiÃ§bir metin eklemeden, sadece oluÅŸturulan gÃ¶rselin URL'sini `<image-tokens-bardstorage://RESPONSE_DATA:...>` ÅŸeklinde dÃ¶ndÃ¼r. Bu URL formatÄ±nÄ± doÄŸrudan kullan.";
        
        // API'ye gÃ¶nderilecek final prompt (Talimat + KullanÄ±cÄ±nÄ±n sorusu)
        const finalPromptForRequest = `${systemContext}\n\nKullanÄ±cÄ± sorusu: ${prompt}`;

        // Ä°steÄŸe dahil edilecek geÃ§erli kullanÄ±cÄ± mesajÄ±
        const currentUserMessage = { role: "user", parts: [{ text: finalPromptForRequest }] };
        
        // Ä°steÄŸe gÃ¶nderilecek iÃ§erik = TÃ¼m geÃ§miÅŸ + mevcut mesaj
        const contentsForRequest = [...conversationHistory, currentUserMessage]; 

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: contentsForRequest,
                    
                    generationConfig: {
                        temperature: 0.7 
                    }
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Ä°stek HatasÄ± (${response.status}): ${errorData.error.message}`);
            }

            const data = await response.json();
            
            const aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (aiResponseText) {
                // BAÅARILI: MesajlarÄ± GEÃ‡MÄ°ÅE EKLE
                conversationHistory.push(currentUserMessage);
                conversationHistory.push({ role: "model", parts: [{ text: aiResponseText }] });

                // TÃœM GEÃ‡MÄ°ÅÄ° yeniden Ã§iz
                formatHistory();
            } else {
                outputDiv.innerHTML += `<p style="color: orange;"><strong>UYARI:</strong> BilalAI geÃ§erli bir yanÄ±t Ã¼retemedi. (BoÅŸ yanÄ±t veya gÃ¼venlik filtresi.)</p>`;
            }

        } catch (error) {
            console.error('Ä°stek HatasÄ±:', error);
            // Sadece hata mesajÄ±nÄ± ekrana bas, geÃ§miÅŸi gÃ¼ncelleme
            outputDiv.innerHTML += `<p style="color: red;"><strong>KRÄ°TÄ°K HATA:</strong> BaÄŸlantÄ± veya API sorunu: ${error.message}</p>`;
        } finally {
            sendButton.disabled = false;
            loader.style.display = 'none';
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }
    }

    // Olay Dinleyicileri
    sendButton.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

</script>

</body>
</html>
