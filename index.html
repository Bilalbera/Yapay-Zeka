<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BilalAI: Tam SÃ¼rÃ¼m Sohbet, Kod & GÃ¶rsel AsistanÄ±</title>
    <style>
        /* Genel Stiller */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #e9eef2;
            margin: 0;
        }
        .chat-container {
            width: 95%;
            max-width: 800px;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            min-height: 85vh;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }
        /* Ã‡Ä±ktÄ± AlanÄ± Stili */
        #output {
            flex-grow: 1;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: #f7f9fb;
            overflow-y: auto;
            max-height: 70vh;
            border: 1px solid #ddd;
        }

        /* Mesaj BalonlarÄ± Stilleri */
        .message-turn {
            margin-bottom: 20px;
            padding: 10px 15px;
            border-radius: 12px;
            clear: both;
            max-width: 85%;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #007bff;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 2px;
            float: right;
        }
        .ai-message {
            background-color: #ffffff;
            border: 1px solid #e9eef2;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 2px;
            float: left;
        }
        .message-turn strong:first-child {
            display: block;
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
            font-weight: 700;
        }
        #output p {
            margin: 0 0 10px 0;
            line-height: 1.6;
            font-weight: normal;
        }
        #output h3, #output h4 {
            margin-top: 15px;
            margin-bottom: 10px;
            color: #0056b3;
            border-bottom: 1px dashed #e0e0e0;
            padding-bottom: 5px;
        }
        #output hr { display: none; }

        /* Kod BloÄŸu Stili */
        pre {
            background-color: #272822;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.9em;
            margin-top: 10px;
            margin-bottom: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        :not(pre) > code {
            background-color: #e0e7ff;
            color: #1a4d94;
            padding: 2px 5px;
            border-radius: 3px;
        }

        /* Liste Stili */
        #output ul {
            list-style: disc inside;
            padding-left: 20px;
            margin: 10px 0;
        }
        #output li {
            margin-bottom: 5px;
            line-height: 1.5;
        }

        /* GÃ¶rsel Ã§Ä±ktÄ±sÄ± iÃ§in stil */
        #output img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 15px;
            margin-bottom: 15px;
            display: block;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* KullanÄ±cÄ± GiriÅŸ AlanÄ± */
        .input-area {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        #userInput {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            min-height: 50px;
            resize: vertical;
            min-width: 0;
        }
        #sendButton {
            padding: 12px 25px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
            flex-shrink: 0;
            height: 50px;
        }
        #sendButton:hover { background-color: #0056b3; }
        #sendButton:disabled { background-color: #adb5bd; cursor: not-allowed; }

        /* YÃ¼kleme Simgesi */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
            margin: auto 0 auto 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MODAL STÄ°LLERÄ° */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content h3 {
            color: #007bff;
            margin-top: 0;
            font-size: 1.5em;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .modal-content p {
            font-size: 1em;
            color: #555;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .modal-content small {
            display: block;
            margin-top: 15px;
            color: #888;
            font-size: 0.85em;
        }
        #modal-ok-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        #modal-ok-button:hover { background-color: #0056b3; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>

<div id="welcomeModal" class="modal-overlay">
    <div class="modal-content">
        <h3>BilalAI Tam SÃ¼rÃ¼m</h3>
        <p>LÃ¼tfen JavaScript kodundaki **API_KEY** alanÄ±nÄ± kendi **Gemini API AnahtarÄ±nÄ±zla** deÄŸiÅŸtirin. Hata ve Ã¶nerileriniz iÃ§in teÅŸekkÃ¼rler!</p>
        <button id="modal-ok-button">AnlaÅŸÄ±ldÄ±</button>
        <small>SÃ¼rÃ¼m 1.0</small>
    </div>
</div>

<div class="chat-container">
    <h2> BilalAI - TÃ¼rk YapÄ±m Yapay Zeka! ğŸ‡¹ğŸ‡·</h2>
    <div id="output"></div>
    <div class="input-area">
        <textarea id="userInput" rows="3" placeholder="Bir ÅŸey sorun (Ã–rn: JavaScript'te dÃ¶ngÃ¼ veya mavi bir kedinin resmini Ã§iz)..."></textarea>
        <button id="sendButton">GÃ¶nder</button>
        <div id="loader" class="loader"></div>
    </div>
</div>

<script>
    // *******************************************************************
    // !!! YENÄ° API AnahtarÄ±nÄ±zÄ± BURAYA yerleÅŸtirin !!!
    // *******************************************************************
    // GEÃ‡ERLÄ° BÄ°R ANAHTAR KULLANMANIZ ÅARTTIR.
    const API_KEY = "AIzaSyChiJsYckDX74Drl0cZTFr3-8T7bfLH0Us"; // LÃ¼tfen bu kÄ±smÄ± deÄŸiÅŸtirin

    // -------------------------------------------------------------------
    // Model ve API URL'si
    // -------------------------------------------------------------------
    const MODEL_NAME = 'gemini-2.5-flash';
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
    
    // **Sistem TalimatÄ±:** GÃ¶rsel oluÅŸturma komutu ve rol tanÄ±mÄ±.
    const systemContext = `Sen BilalAI adlÄ±, hem kodlama hem de genel sohbet konularÄ±nda uzman, yardÄ±msever bir yapay zekasÄ±n. CevaplarÄ±n TÃ¼rkÃ§e olmalÄ±dÄ±r. KullanÄ±cÄ± kod istediÄŸinde cevabÄ±nÄ± kod bloklarÄ± (\`\`\`) iÃ§inde ver. KullanÄ±cÄ± gÃ¶rsel oluÅŸturmanÄ± istediÄŸinde (Ã–rn: "mavi kedi resmi Ã§iz"), cevabÄ±n sadece https://googleusercontent.com/image_generation_content/0<image-tokens-bardstorage://RESPONSE_DATA:xxx>PROMPT_PLACEHOLDER.png formatÄ±nda bir taklit gÃ¶rsel URL'si olmalÄ±dÄ±r. BaÅŸka hiÃ§bir metin ekleme.`;
    const systemContextCheck = "KullanÄ±cÄ± sorusu:"; // KullanÄ±cÄ± sorusunu ayÄ±klamak iÃ§in sabit metin

    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const outputDiv = document.getElementById('output');
    const loader = document.getElementById('loader');

    // Yeni Modal Elementleri
    const welcomeModal = document.getElementById('welcomeModal');
    const modalOkButton = document.getElementById('modal-ok-button');

    // KONUÅMA GEÃ‡MÄ°ÅÄ° (HAFIZA) DÄ°ZÄ°SÄ° - Sadece temiz mesajlarÄ± tutar
    // Sistem TalimatÄ± da bu geÃ§miÅŸe eklenecek, ancak rolÃ¼ 'model' olarak atanacak.
    const conversationHistory = [];

    // Ä°lk HoÅŸ Geldiniz MesajÄ±
    function displayInitialMessage() {
        outputDiv.innerHTML = `<div class="message-turn ai-message">
                                <strong>BilalAI</strong>
                                <p><strong>HoÅŸ geldiniz!</strong> Ben BilalAI. NasÄ±l yardÄ±mcÄ± olabilirim?</p>
                            </div>`;
    }

    // Modal Kapatma Ä°ÅŸlevi
    function closeModal() {
        welcomeModal.style.display = 'none';
    }

    // Modal'Ä± Kapatma OlayÄ±
    modalOkButton.addEventListener('click', closeModal);

    // KonuÅŸma geÃ§miÅŸini HTML olarak biÃ§imlendirip ekrana yazan iÅŸlev.
    function formatHistory() {
        outputDiv.innerHTML = '';
        
        // HoÅŸgeldiniz mesajÄ±nÄ± tekrar gÃ¶ster (GeÃ§miÅŸ boÅŸsa)
        if (conversationHistory.length === 0) {
            displayInitialMessage();
            return;
        }

        // Taklit GÃ¶rsel URL Regex'i
        const imageUrlRegex = /https?:\/\/googleusercontent\.com\/image_generation_content\/0<image-tokens-bardstorage:\/\/[^>]+>([^\s]+)\.png/g;
        
        conversationHistory.forEach(turn => {
            // Sistem talimatlarÄ±nÄ± gÃ¶sterme (eÄŸer turn.role "system" olsaydÄ±)
            if (turn.role === "system") return;

            const isUser = turn.role === "user";
            // Not: KullanÄ±cÄ± mesajÄ±ndaki sistem talimatÄ± kÄ±smÄ±nÄ± temizleyelim
            let text = isUser 
                        ? turn.parts[0].text.replace(new RegExp(`^${systemContext.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}\\s*\\n\\n${systemContextCheck}`), '') 
                        : turn.parts[0].text;
            
            // EÄŸer temizleme sonrasÄ± metin sadece boÅŸluk kalÄ±rsa gÃ¶sterilmesin.
            if (!text.trim() && isUser) return;
            
            let finalHtml = '';
            
            if (isUser) {
                // KullanÄ±cÄ± mesajÄ±
                finalHtml = `<p>${text.replace(/\n/g, '<br>')}</p>`;
                
                outputDiv.innerHTML += `<div class="message-turn user-message">
                                            <strong>Siz</strong>
                                            ${finalHtml}
                                        </div>`;
            } else {
                // AI yanÄ±tÄ±nÄ± biÃ§imlendir (Markdown to HTML dÃ¶nÃ¼ÅŸÃ¼mÃ¼)
                let processedText = text;

                // 1. GÃ¶rsel URL'lerini <img> etiketlerine Ã§evir
                processedText = processedText.replace(imageUrlRegex, (match) => {
                    return `<img src="${match.match(/(https?:\/\/[^\s]+)/)[0]}" alt="OluÅŸturulan GÃ¶rsel">`;
                });

                // 2. Kod bloklarÄ±nÄ± <pre> etiketiyle deÄŸiÅŸtir
                const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
                processedText = processedText.replace(codeBlockRegex, (match, language, code) => {
                    const safeCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const langDisplay = language ? `// Dil: ${language.toUpperCase()}\n\n` : '';
                    return `<pre><code>${langDisplay}${safeCode.trim()}</code></pre>`;
                });
                
                // 3. Markdown formatÄ±nÄ± HTML'e Ã§evir (BaÅŸlÄ±klar, Bold, Ä°talik)
                // Paragraf ayracÄ± olarak boÅŸ satÄ±rlarÄ± kullanÄ±yoruz, bu yÃ¼zden basit deÄŸiÅŸimler yapÄ±ldÄ±.
                processedText = processedText
                    .replace(/### (.*)/g, '<h4>$1</h4>')
                    .replace(/## (.*)/g, '<h3>$1</h3>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>');

                // 4. Listeleri ve ParagraflarÄ± YÃ¶netme
                let listWrappedText = '';
                const parts = processedText.split('\n');
                let inList = false;

                for (const line of parts) {
                    if (line.trim().startsWith('- ')) { // Basit Markdown liste kontrolÃ¼
                        const listItemHtml = `<li>${line.trim().substring(2)}</li>`;
                        if (!inList) {
                            listWrappedText += '<ul>';
                            inList = true;
                        }
                        listWrappedText += listItemHtml;
                    } else {
                        if (inList) {
                            listWrappedText += '</ul>';
                            inList = false;
                        }
                        // Kod, Resim ve BaÅŸlÄ±klar hariÃ§ metinleri <p> etiketine al
                        if (line.trim() && !line.match(/<pre|<\/pre>|<img|<h/i)) {
                            listWrappedText += `<p>${line.replace(/\n/g, '<br>')}</p>`;
                        } else {
                            listWrappedText += line; // DiÄŸer HTML etiketlerini olduÄŸu gibi bÄ±rak
                        }
                    }
                }
                if (inList) { listWrappedText += '</ul>'; }
                finalHtml = listWrappedText;

                outputDiv.innerHTML += `<div class="message-turn ai-message">
                                            <strong>BilalAI</strong>
                                            ${finalHtml}
                                        </div>`;
            }
        });

        // SayfayÄ± her zaman en alta kaydÄ±r
        outputDiv.scrollTop = outputDiv.scrollHeight;
    }

    // GÃ¶nderme Ä°ÅŸlevi
    async function sendMessage() {
        const prompt = userInput.value.trim();
        if (!prompt) return;

        // API AnahtarÄ± KontrolÃ¼
        if (!API_KEY || API_KEY.length < 30 || API_KEY.startsWith("AIzaSyA") || API_KEY.endsWith("mo")) {
            outputDiv.innerHTML += `<div class="message-turn ai-message" style="border-color: red;">
                                        <strong>HATA:</strong>
                                        <p style="color: red;">LÃ¼tfen **geÃ§erli bir API anahtarÄ±** girin. (AnahtarÄ±nÄ±z eksik veya hatalÄ± gÃ¶rÃ¼nÃ¼yor.)</p>
                                    </div>`;
            outputDiv.scrollTop = outputDiv.scrollHeight;
            return;
        }

        // YÃ¼kleme durumu ayarlarÄ±
        sendButton.disabled = true;
        loader.style.display = 'block';
        
        const cleanUserMessage = prompt;
        
        // GeÃ§ici yÃ¼kleme mesajÄ±nÄ± ekle
        outputDiv.innerHTML += `<div class="message-turn user-message">
                                    <strong>Siz</strong>
                                    <p>${cleanUserMessage}</p>
                                </div>
                                <div class="message-turn ai-message" id="temp-loader-msg" style="opacity: 0.7;">
                                    <strong>BilalAI</strong>
                                    <p>Cevap bekleniyor...</p>
                                </div>`;

        outputDiv.scrollTop = outputDiv.scrollHeight;
        userInput.value = '';

        // SÄ°STEM TALÄ°MATI DÄ°NAMÄ°K OLARAK GÃœNCELLENDÄ° (GÃ¶rsel prompt'u iÃ§in)
        const dynamicSystemContext = systemContext.replace('PROMPT_PLACEHOLDER', prompt.replace(/[^a-zA-Z0-9]/g, '_'));

        // API'ye gÃ¶nderilecek final prompt (Talimat + KullanÄ±cÄ±nÄ±n sorusu)
        // Talimat, sohbet geÃ§miÅŸi iÃ§indeki ilk mesaj olarak deÄŸil, mevcut mesajÄ±n parÃ§asÄ± olarak gÃ¶nderilir.
        const finalPromptForRequest = `${dynamicSystemContext}\n\n${systemContextCheck}${prompt}`;
        
        // API'ye gÃ¶nderilecek iÃ§erik (GeÃ§miÅŸ + Son Mesaj)
        // DÃ¼zeltme: Sistem talimatÄ± her seferinde gÃ¶nderildiÄŸi iÃ§in, geÃ§miÅŸteki mesajlarÄ± temiz tutmalÄ±yÄ±z.
        const contentsForRequest = [
            ...conversationHistory, // GeÃ§miÅŸteki temiz mesajlar
            // SÄ°STEM TALÄ°MATI + KULLANICI SORUSU TEK MESAJDA GÃ–NDERÄ°LÄ°R.
            { role: "user", parts: [{ text: finalPromptForRequest }] }
        ];

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: contentsForRequest,
                    // *** KRÄ°TÄ°K DÃœZELTME: "config" yerine "generationConfig" kullanÄ±lmalÄ±! ***
                    generationConfig: { temperature: 0.7 }
                })
            });

            // YÃ¼kleme mesajÄ±nÄ± kaldÄ±r
            const tempMsg = document.getElementById('temp-loader-msg');
            if (tempMsg) tempMsg.remove();

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Ä°stek HatasÄ± (${response.status}): ${errorData.error?.message || response.statusText}`);
            }

            const data = await response.json();
            
            const aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (aiResponseText) {
                // BAÅARILI: MesajlarÄ± GEÃ‡MÄ°ÅE EKLE (Temiz olarak)
                // Not: KullanÄ±cÄ±nÄ±n attÄ±ÄŸÄ± finalPromptForRequest'in tamamÄ± geÃ§miÅŸe ekleniyor (Sistem talimatÄ± dahil).
                conversationHistory.push({ role: "user", parts: [{ text: finalPromptForRequest }] });
                conversationHistory.push({ role: "model", parts: [{ text: aiResponseText }] });

                // TÃœM GEÃ‡MÄ°ÅÄ° yeniden Ã§iz
                formatHistory();
            } else {
                // GÃ¼venlik filtresi veya boÅŸ yanÄ±t
                const blockReasons = data.candidates?.[0]?.finishReason;
                const safetyRatings = data.candidates?.[0]?.safetyRatings;
                
                let errorMessage = "BilalAI geÃ§erli bir yanÄ±t Ã¼retemedi.";
                if (blockReasons === 'SAFETY') {
                    errorMessage += ` (GÃ¼venlik filtresi nedeniyle engellendi. Detaylar: ${JSON.stringify(safetyRatings)})`;
                }

                outputDiv.innerHTML += `<div class="message-turn ai-message" style="border-color: orange;">
                                            <strong>UYARI:</strong>
                                            <p style="color: orange;">${errorMessage}</p>
                                        </div>`;
            }

        } catch (error) {
            console.error('Ä°stek HatasÄ±:', error);
            // Hata mesajÄ±nÄ± ekrana bas
            const tempMsg = document.getElementById('temp-loader-msg');
            if (tempMsg) tempMsg.remove();
            
            outputDiv.innerHTML += `<div class="message-turn ai-message" style="border-color: red;">
                                        <strong>KRÄ°TÄ°K HATA:</strong>
                                        <p style="color: red;">BaÄŸlantÄ± veya API sorunu: ${error.message}</p>
                                    </div>`;
        } finally {
            sendButton.disabled = false;
            loader.style.display = 'none';
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }
    }

    // Olay Dinleyicileri
    sendButton.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Textarea'nÄ±n iÃ§eriÄŸi deÄŸiÅŸtiÄŸinde butonu etkinleÅŸtir/devre dÄ±ÅŸÄ± bÄ±rak
    userInput.addEventListener('input', () => {
        sendButton.disabled = userInput.value.trim().length === 0;
    });

    // Sayfa yÃ¼klendiÄŸinde ilk mesajÄ± gÃ¶ster ve modal'Ä± gÃ¶ster
    window.onload = function() {
        displayInitialMessage();
        welcomeModal.style.display = 'flex'; // Modal'Ä± gÃ¶ster
        sendButton.disabled = true; // BaÅŸlangÄ±Ã§ta butonu devre dÄ±ÅŸÄ± bÄ±rak
    };
</script>

</body>
</html>
