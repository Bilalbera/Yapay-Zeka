<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 2.0 - Local Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap');
        body { font-family: 'Google Sans', sans-serif; background-color: #f8fafd; }
        .sidebar { transition: all 0.3s ease; }
        .chat-area { height: calc(100vh - 180px); scroll-behavior: smooth; }
        .message-ai { background-color: transparent; }
        .message-user { background-color: #e9eef6; border-radius: 20px; padding: 10px 20px; max-width: 80%; }
        .typing-indicator::after { content: '...'; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        pre { background: #1e1e1e; color: white; padding: 15px; border-radius: 12px; margin: 10px 0; overflow-x: auto; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-[#1f1f1f]">

    <aside id="sidebar" class="w-72 bg-[#f0f4f9] flex flex-col p-4 z-50">
        <button onclick="newChat()" class="flex items-center gap-3 bg-[#dde3ea] hover:bg-[#d3d9e1] transition-colors p-3 rounded-full w-fit px-5 mb-8">
            <i class="fa-solid fa-plus text-lg"></i>
            <span class="font-medium text-sm">Yeni sohbet</span>
        </button>

        <div class="flex-1 overflow-y-auto">
            <p class="text-xs font-semibold text-gray-500 mb-4 px-2">Yakın Zamandakiler</p>
            <div id="chatHistory" class="space-y-1">
                </div>
        </div>

        <div class="mt-auto space-y-2 pt-4 border-t border-gray-300">
            <div class="flex items-center gap-3 p-3 hover:bg-[#e1e6ed] rounded-lg cursor-pointer transition-colors">
                <i class="fa-regular fa-circle-question"></i> <span class="text-sm">Yardım</span>
            </div>
            <div class="flex items-center gap-3 p-3 hover:bg-[#e1e6ed] rounded-lg cursor-pointer transition-colors">
                <i class="fa-solid fa-clock-rotate-left"></i> <span class="text-sm">Etkinlik</span>
            </div>
            <div id="modelStatus" class="text-[10px] uppercase tracking-widest text-blue-600 font-bold px-3">
                Motor Bekleniyor...
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative bg-white md:rounded-l-[30px] shadow-xl overflow-hidden">
        
        <header class="p-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="text-xl font-medium">Gemini <span class="text-blue-600 text-sm">Local</span></span>
                <i class="fa-solid fa-caret-down text-xs text-gray-500"></i>
            </div>
            <div class="flex gap-4 items-center">
                <div class="bg-blue-100 text-blue-700 text-xs font-bold px-3 py-1 rounded-full">Gemma 2B</div>
                <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-white text-xs">U</div>
            </div>
        </header>

        <div id="chatDisplay" class="chat-area overflow-y-auto px-4 md:px-20 py-10 space-y-10">
            <div id="welcomeScreen" class="h-full flex flex-col items-center justify-center text-center space-y-6">
                <h2 class="text-4xl font-medium bg-gradient-to-r from-blue-600 via-purple-500 to-red-400 bg-clip-text text-transparent">Merhaba, Sana nasıl yardımcı olabilirim?</h2>
                <p class="text-gray-500 max-w-md">API anahtarı olmadan, doğrudan tarayıcında çalışan yerel zeka motoru.</p>
            </div>
        </div>

        <div class="p-4 bg-white">
            <div class="max-w-3xl mx-auto">
                <div class="relative flex items-end bg-[#f0f4f9] rounded-[28px] p-2 pr-4 focus-within:shadow-md transition-shadow">
                    <textarea id="prompt" rows="1" placeholder="Buraya bir şeyler yazın" 
                        class="w-full bg-transparent p-4 outline-none resize-none max-h-40 text-base"
                        oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'"></textarea>
                    
                    <div class="flex gap-3 mb-2">
                        <i class="fa-solid fa-image text-gray-500 hover:text-blue-600 cursor-pointer p-2"></i>
                        <i class="fa-solid fa-microphone text-gray-500 hover:text-blue-600 cursor-pointer p-2"></i>
                        <button id="sendBtn" disabled onclick="handleAction()" class="bg-white rounded-full w-10 h-10 flex items-center justify-center shadow-sm disabled:opacity-50">
                            <i class="fa-solid fa-paper-plane text-blue-600"></i>
                        </button>
                    </div>
                </div>
                <p class="text-[11px] text-center text-gray-400 mt-3">Gemini, kişiler ve yerler hakkında yanlış bilgiler verebilir. <a href="#" class="underline">Gizliliğinizi kontrol edin.</a></p>
            </div>
        </div>
    </main>

    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        const chatDisplay = document.getElementById('chatDisplay');
        const promptInput = document.getElementById('prompt');
        const sendBtn = document.getElementById('sendBtn');
        const modelStatus = document.getElementById('modelStatus');
        const welcomeScreen = document.getElementById('welcomeScreen');

        // Yapılandırma
        let engine;
        const modelId = "Gemma-2b-it-q4f16_1-MLC"; // Google'ın yerel modeli

        async function initAI() {
            engine = new webllm.MLCEngine();
            engine.setInitProgressCallback((report) => {
                modelStatus.innerText = report.text.includes('Finish') ? "Zeka Aktif" : "Yükleniyor...";
                if(report.progress === 1) {
                    sendBtn.disabled = false;
                }
            });
            await engine.reload(modelId);
        }

        window.handleAction = async () => {
            const text = promptInput.value.trim();
            if (!text) return;

            if (welcomeScreen) welcomeScreen.remove();

            // Kullanıcı Mesajı
            addMessage(text, 'user');
            promptInput.value = '';
            promptInput.style.height = 'auto';

            // AI Yanıt Alanı
            const aiDiv = addMessage("...", 'ai');
            aiDiv.classList.add('typing-indicator');

            try {
                const messages = [{ role: "user", content: text }];
                const chunks = await engine.chat.completions.create({ messages });
                const reply = chunks.choices[0].message.content;
                
                aiDiv.classList.remove('typing-indicator');
                aiDiv.innerText = reply;
                saveToSidebar(text);
            } catch (e) {
                aiDiv.innerText = "Hata: Bellek yetersiz veya GPU desteklenmiyor.";
            }
        };

        function addMessage(text, sender) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex gap-4 ${sender === 'user' ? 'justify-end' : ''}`;
            
            const icon = sender === 'ai' ? `<div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-600 to-purple-400 shrink-0"></div>` : '';
            
            wrapper.innerHTML = `
                ${icon}
                <div class="${sender === 'user' ? 'message-user' : 'message-ai flex-1'}">
                    <p class="text-sm leading-relaxed">${text}</p>
                </div>
            `;
            
            chatDisplay.appendChild(wrapper);
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
            return wrapper.querySelector('p');
        }

        function saveToSidebar(text) {
            const history = document.getElementById('chatHistory');
            const item = document.createElement('div');
            item.className = "flex items-center gap-3 p-3 hover:bg-[#e1e6ed] rounded-lg cursor-pointer text-sm truncate";
            item.innerHTML = `<i class="fa-regular fa-message text-xs"></i> ${text.substring(0, 30)}...`;
            history.prepend(item);
        }

        window.newChat = () => location.reload();

        // Klavye kontrolü
        promptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleAction();
            }
        });

        initAI();
    </script>
</body>
</html>
