<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BilalAİ - v0.1</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #0f0f0f; --chat-bg: #1a1a1a; --user-msg: #005c4b; --ai-msg: #262626; --accent: #00a884; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #e9edef; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Giriş Modalı */
        #welcome-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .modal-content { background: #222; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px; border: 1px solid var(--accent); }
        .modal-content p { margin-bottom: 20px; line-height: 1.6; }
        .modal-content button { background: var(--accent); border: none; padding: 10px 30px; color: white; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .version-text { font-size: 0.7rem; color: #666; margin-top: 15px; display: block; }

        header { background: var(--chat-bg); padding: 15px; text-align: center; border-bottom: 1px solid #333; color: var(--accent); font-size: 1.4rem; font-weight: bold; }
        #chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .msg-box { display: flex; flex-direction: column; max-width: 85%; }
        .user { align-self: flex-end; }
        .ai { align-self: flex-start; }
        .name-tag { font-size: 0.8rem; margin-bottom: 4px; font-weight: bold; }
        .user .name-tag { color: #8696a0; text-align: right; }
        .ai .name-tag { color: var(--accent); }
        .bubble { padding: 12px 16px; border-radius: 15px; font-size: 1rem; line-height: 1.6; background: var(--ai-msg); }
        .user .bubble { background: var(--user-msg); border-top-right-radius: 2px; }
        .ai .bubble { border-top-left-radius: 2px; border: 1px solid #333; }

        pre { background: #000 !important; padding: 15px; border-radius: 8px; margin: 10px 0; overflow-x: auto; position: relative; }
        code { color: #dcdcaa; font-family: monospace; }
        .copy-btn { position: absolute; right: 10px; top: 10px; background: #444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; }
        
        .ai-img { width: 100%; max-width: 400px; border-radius: 10px; margin-top: 10px; border: 1px solid #444; }
        .input-bar { background: var(--chat-bg); padding: 20px; display: flex; gap: 10px; border-top: 1px solid #333; }
        input { flex: 1; background: #2a2a2a; border: none; padding: 14px; border-radius: 25px; color: white; outline: none; }
        button#send { background: var(--accent); border: none; width: 50px; height: 50px; border-radius: 50%; color: white; cursor: pointer; }
        .loader { display: none; padding: 10px 20px; color: var(--accent); font-size: 0.8rem; }
    </style>
</head>
<body>

<div id="welcome-modal">
    <div class="modal-content">
        <p><strong>BilalAİ Yapım Aşamasındadır.</strong><br>Eğer Bir Hata Bulursanız <br><span style="color:var(--accent)">bilaliletisim465@gmail.com</span><br> Gmailine Bildiriniz.</p>
        <button onclick="closeModal()">TAMAM</button>
        <span class="version-text">versiyon 0.1</span>
    </div>
</div>

<header>BilalAİ</header>
<div id="chat-area"></div>
<div id="loader" class="loader">BilalAİ düşünüyor...</div>
<div class="input-bar">
    <input type="text" id="input" placeholder="Bir kedi çiz de, sonra onu mavi yap de...">
    <button id="send"><i class="fas fa-paper-plane"></i></button>
</div>

<script>
    let chatHistory = []; // Hafıza burada tutuluyor
    const chatArea = document.getElementById('chat-area');
    const input = document.getElementById('input');
    const loader = document.getElementById('loader');

    function closeModal() { document.getElementById('welcome-modal').style.display = 'none'; }

    function addMessage(text, type) {
        const box = document.createElement('div');
        box.className = `msg-box ${type}`;
        const tag = document.createElement('div');
        tag.className = 'name-tag';
        tag.innerText = type === 'user' ? 'Sen' : 'BilalAİ';
        const bubble = document.createElement('div');
        bubble.className = 'bubble';

        if (type === 'ai') {
            bubble.innerHTML = marked.parse(text);
            bubble.querySelectorAll('pre').forEach(pre => {
                const btn = document.createElement('button');
                btn.className = 'copy-btn'; btn.innerText = 'Kopyala';
                btn.onclick = () => { navigator.clipboard.writeText(pre.innerText.replace('Kopyala','')); btn.innerText='Kopyalandı!'; };
                pre.appendChild(btn);
            });
        } else { bubble.innerText = text; }

        box.appendChild(tag); box.appendChild(bubble);
        chatArea.appendChild(box);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    async function handleChat() {
        const msg = input.value.trim();
        if (!msg) return;

        addMessage(msg, 'user');
        input.value = '';
        loader.style.display = 'block';

        const lowMsg = msg.toLowerCase();
        
        // GÖRSEL HAFIZA MANTIĞI
        if (lowMsg.includes("çiz") || lowMsg.includes("yap") || lowMsg.includes("resim") || lowMsg.includes("görsel")) {
            // Önceki mesajları kontrol et (Hafıza)
            let fullPrompt = msg;
            if ((lowMsg.includes("onu") || lowMsg.includes("bunu")) && chatHistory.length > 0) {
                fullPrompt = "previous context: " + chatHistory[chatHistory.length - 1] + " now apply: " + msg;
            }

            const imgUrl = `https://pollinations.ai/p/${encodeURIComponent(fullPrompt)}?width=1024&height=1024&nologo=true`;
            setTimeout(() => {
                addMessage(`İsteğini hafızama göre çizdim: \n\n <img src="${imgUrl}" class="ai-img">`, 'ai');
                loader.style.display = 'none';
                chatHistory.push(msg);
            }, 1500);
            return;
        }

        // METİN HAFIZA MANTIĞI (API)
        try {
            const response = await fetch("https://api-inference.huggingface.co/models/HuggingFaceH4/zephyr-7b-beta", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    inputs: `<|system|>Sen BilalAİ'sin. Önceki konuşmaları hatırla. Türkçe cevap ver.</s>\n<|user|>${chatHistory.join(" ")} ${msg}</s>\n<|assistant|>`,
                    parameters: { max_new_tokens: 250 }
                })
            });
            const data = await response.json();
            let aiRes = data[0].generated_text.split("<|assistant|>")[1].trim();
            addMessage(aiRes, 'ai');
            chatHistory.push(msg);
        } catch (e) {
            addMessage("Şu an biraz yoğunum ama seni anlıyorum. Devam edelim!", 'ai');
        } finally {
            loader.style.display = 'none';
        }
    }

    document.getElementById('send').onclick = handleChat;
    input.onkeypress = (e) => { if (e.key === 'Enter') handleChat(); };
    
    // İlk karşılama mesajı
    window.onload = () => { addMessage("BilalAİ v0.1'e hoş geldin! Sana nasıl yardımcı olabilirim?", "ai"); };
</script>
</body>
</html>
